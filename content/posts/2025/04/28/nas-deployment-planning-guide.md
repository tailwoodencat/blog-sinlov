---
title: "NAS 部署规划指南"
date: 2025-04-28T17:33:20+08:00
description: "NAS Deployment Planning Guide"
draft: false
categories: ['hardware']
tags: ['hardware']
toc:
  enable: true
  auto: false
math:
  enable: true
mapbox:
  accessToken: ""
share:
  enable: true
comment:
  enable: true
---


## 备份3+2+1原则

既然使用NAS服务器，先复习 `数据备份321原则`

数据备份的3-2-1规则规定，应在`两个不同的存储介质`上`至少存储三个数据副本或版本`，其中`一个不在现场设施中存储`

- `三个数据副本或版本`：在不同时间段内拥有至少三个不同版本的数据，可确保从影响多个版本的灾难事故中恢复。任何完善的备份系统都将具有三个以上的副本或版本。

- `两种不同的存储介质`：不应在同一存储介质上存储两个数据副本

> 例如，使用苹果公司的TimeMachine。使用硬盘应用程序将硬盘分为两个虚拟卷，然后使用TimeMachine将第一个虚拟卷备份到第二个虚拟卷。
>
> 如果发生故障，则这两个虚拟卷的数据备份也会失效。

- `一个异地备份`：至少一份备份副本应与需要备份的内容存储在不同的物理位置。

> 比如会议发言人在一次演讲中表示不想采用磁带存储，因为其IT部门的一名员工将磁带放置在服务器顶部，当服务器产生故障高温导致磁带融化变形。
>
> 其实这个问题的本身不是磁带存储，而是没有将备份磁带放置在安全的地方。

备份3+2+1 规则是一个很好的规则，长期以来一直很好地服务于数据存储领域。

## UPS 规划

1. UPS 核心价值
    - 提供 `服务器安全关机时间`， 而不是给服务器供电
	- 提供 UPS服务 硬件数据支持，也就是 设备支持 UPS 型号选择必须考虑的
	- 提供稳定 功率输出，防止电网冲击损耗服务器
2. UPS 接入方式
    - 网络接入，由 UPS 服务，通知各种 设备的 UPS 客户端，做到安全关机
	- USB接入，由 设备接入 UPS ，支持 UPS服务，本机也是 UPS 客户端，达到安全关机
3. UPS 容量选择
    - 由于 UPS 长期工况为满电，且单次放电功率大（停电过程设备工作导致）， 导致 UPS 不适合 锂电池 标准工况，使用锂电池也必须预留 30% 以上不充电容量，防止过冲
	- 关机时间，家庭使用，存在突然闪断或者临时停电，`UPS 服务 一般在断电 几分钟后发起 关机信号`，不要设置为 断电就关机
	- 预留 最低电量，和长时间使用导致的容量损失，需要保障 最大功率下，容量为 `关机时间需要的电量 3倍 即可`

## 网络规划

NAS 既然叫 网络附属存储，那么网络本身就是优先考虑的

1. 木桶原理，网络整体速度，由最慢的设备决定
	- 如果是 NAS 让 电视播放视频，那么目前主流电视机 千兆网卡决定，NAS 那边怎么努力也是千兆
	- 如果在线剪辑这种高强度工作，可以拉一根根 10G 或者 40G 直连网线，在剪辑设备到 NAS，而不是全部网络都改造
	- 小型工作室有多人协作剪辑需求，可以建立单独的 10/40G 网络平面
2. 内网尽量使用 IP 地址，不要建立 DNS ，转化DNS会导致不少的损耗，那么NAS 内网地址不但需要固定，且不能改变
3. 不要把 NAS 服务器映射到公网，系统漏洞随时存在，NAS服务器全部端口映射出去，只能被当肉鸡，或者被黑客加密数据敲诈

## 文件系统规划

### 主流文件系统特性

| FS/Fea. | windows | macOS | Linux | 加密  | 日志  | 特殊  | 大小写 |
| --- | --- | --- | --- | --- | --- | --- | --- |
| NTFS | 读写  | 只读  | 读写  | 可选  | 有   | Microsot闭源 | 可选(系统盘不支持) |
| APFS | /   | 读写  | /   | 可选  | 有   | 专为固态优化 | 可选(系统盘不支持) |
| HFS+ | /   | 读写  | /   | 可选  | 有   | OSX旧版支持 | 可选  |
| ExFAT | 读写  | 读写  | /   | /   | /   | 移动设备优化 | /   |
| FAT32 | 读写  | 读写  | 读写  | /   | /   | 单文件`<4G` | /   |
| Ext4 | /   | /   | 读写  | 可选  | 有   | Linux | 区分  |
| XFS | /   | /   | 读写  | /   | 有   | SiliconGraphic/RedHat | 区分  |
| btrFS | /   | /   | 读写  | 可选  | 有   | Oracle/RedHat/SUSE | 区分  |
| ZFS | /   | /   | 读写  | 可选  | 有   | Oracle/OpenZFS | 区分  |

> 注意：`/` 代表原生不支持；`可选` 代表允许配置；HFS+也称 `Mac OS 扩展`

各种文件系统特性导致，一旦用户跨系统共享数据，有高可用高可靠需求，必须使用 NAS服务器

### NAS服务器文件系统选择原则

-  **NAS厂家选文件系统的刚需是快照**

> [btrfs Snapshots ](https://archive.kernel.org/oldwiki/btrfs.wiki.kernel.org/index.php/SysadminGuide.html#Snapshots)  快照使用说明

- 热分区调整，如果需要支持，只能 btrfs

> 在 btrfs和zfs 能用之前，快照主要靠LVM（逻辑卷管理器）

1. 满足`数据备份准则3` 也就是 `至少存储三个数据副本或版本`
	- 包含数据备份快照的文件系统有 btrfs xfs afs ReFS
	- 不直接支持快照的文件系统，也可以建立软件备份做到
	- 跨不同类型硬盘，算 `不同的存储介质`
	- 跨设备备份，算 `不同的存储介质`，也可以支持 `至少存储三个数据副本或版本`

2. 满足`数据备份准则2` 也就是 `两个不同的存储介质`
	- 不同存储池备份即可，可在单设备上执行
	- 冷热数据分离，也是不同的存储介质

3. 其他文件系统选择
	- 如果有 高性能读需求，可以不使用支持备份快照的文件系统，比如 ext4
	- 有其他文件系统参与，务必不要跨系统使用，比如 linux nas 系统，挂载 NTFS，或者 APFS
	- 使用其他文件系统，请保证数据有额外备份

### 使用 NAS 的操作系统文件系统选择

> 注意是使用 NAS 服务的 设备，比如 macbook ，windows pc

使用 NAS 是跨操作系统，在跨操作系统使用的情形下，安全正确且行之有效的方式基本只有一种，那就是

1. Linux 系统，ext4(固态+机械)，zfs(固态)
2. Windows下请使用 `NTFS(固态+机械)`，ReFS (固态 且需要注意只能数据盘，因为不能回滚版本)
3. MacOS下请使用 `APFS(固态)`，`HFS+(机械)`
4. 尽量不跨操作系统转移数据，极慎exFAT

不建议尝试 `第三方软件进行反向或双向`操作，如 APFS/NTFS for Win/Mac

 > Linux上的NTFS实现只有journal replaying但不会记录journal，本质上和exfat并没啥区别
> NTFS非要在Mac上用可以开个虚拟机共享出来

### 使用 NAS 的操作系统共享方式

1. `NFS` 共享，支持主流操作系统，但 nfs 本身版本区别，部分操作系统支持不完全，支持多人文件读写，没有加密授权等功能（可扩展支持），性能好
2. `SMB/Samba/CIFS` 共享，对外习惯叫 smb 协议，支持操作系统最多，兼容最好，支持文件多人读写，SMB 提供端到端加密、安全性高，配置选项丰富，缺点是性能因为功能支持多不太好
3. `WebDAV` 由互联网工程任务组的工作组在 RFC 4918 中定义，基于 HTTP 的，所以具有 HTTP 的所有优点，包括容易穿越防火墙，缺点是性能更弱
4. `iscsi` ，将NAS上的空间当作本地磁盘来用，优点是性能好，但只能支持单用户读写，多用户只能做只读

## 存储池规划

这个是 建立一套 NAS 存储先考虑的，会影响后面几年的

### RAID 各种模式介绍

| 名称  | RaiD 模式 | 最少硬盘 | 最大容错 | 可用容量 | 读取性能 | 写入性能 | 安全性 | 目的  | 用途  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| 带条  | Raid0 | 1   | 0   | n   | n   | n   | 一个硬盘异常，全部硬盘数据都会异常 | 追求最大速度，安全性由其他存储保证 | 缓存，高性能存储 |
| 镜像  | Raid1 | 2   | n-1 | 1   | n   | 1   | 高安全允许在线服务 | 追求最大安全性 | 安全存储 |
| 线性  | JBOD | 1   | 0   | n   | 1   | 1   | 区别 Raid0 只是损坏的盘异常 | 追求最大容量，和扩容效率 | 存储备份，可以多组 JBOD 经济安全备份 |
| Raid5 | Raid5 | 3   | 1   | n-1 | n-1 | n-1 | 较高，但是2块损坏则无法找回数据 | 追求最大容量、最小预算 | 存储，可以多组 RAID 5 安全备份 |
| Raid6 | Raid6 | 4   | 2   | n-2 | n-2 | n-2 | 同 RAID5，额外多允许一块盘损坏 | 追求最大容量、预算不足的用户使用 | 存储，可以多组 RAID 5/6 安全备份 |

- 如果追求安全 Raid 1 ，有条件 Raid10 （即先 组 Raid 1 然后多个 Raid1 组 Raid 0）

- 如果预算有限，有 5 块或更多硬盘，推荐使用 RAID6，但是每个 RAID `最好不要超过 8 块硬盘`

- 预算足够，JBOD 集群是最好的归档选择

- 最安全的选择是 `多台 NAS 多备份，而不是依赖 RAID`

#### RAID `扩容/重建` 速度

数据盘出现问题，或者需要扩容 存储池时，需要对 RAID 进行操作，这个操作时间其实是有明显区别的

JBOD >= Raid1 > Raid 0 > Raid10 > Raid 5/6

直观告知数据，同为 SATA3 8T 企业机械盘的情况下 （控制变量，机械盘 为扩容 重建 操作 主要存储介质）
数据都为 4T 的业务数据 （ 容量为 单盘 8T 一半，正常使用 存储池不应该超过 容量的 60%）

- JBOD 扩容直接初始化新盘即可，重建为 从备份 数据源重新写一块，等于 Raid 1
- 在 Raid 1 下，扩容 或者 更换硬盘 重建 需要 12h 到 18h
- 在 Raid 0 只有扩容，速度为多块机械盘写，需要 16h 到 24h
- Raid10，扩容/重建 涉及多块硬盘，需要 18 h 到 30h
- Raid 5/6，的速度最慢，涉及到数据校验和数据还原，需要 30h 到 100h

> 提供的时间供参考，如果数据是非常零散的小文件，时间加倍，如果是大块规格对齐的文件，可以减少不少时间

#### 企业 NAS RAID 规划

- 企业第一要求是 `数据安全`，然后是 `性能满足业务需求`

在预算足够的情况下，建立 3级 NAS存储

1.  `归档级`存储， 使用 多台 NAS 组 JBOD 存储（建议 3台以上 组成集群），确保某片或者多片 JBOD 归档数据盘损坏后，可以安全更换，再同步 JBOD 集群内的备份的归档，恢复数据
2.  `托管级`存储，业务需要使用 高性能存储时，使用 Raid0 满足业务需求的同时，如果有条件，可以 双机 Raid 0 做高性能存储互备，做数据容灾，并配置对应 JBOD 集群 存储定时备份
3.  `镜像级`存储，对安全级别要求高的，但是性能没要求的业务，做 Raid10， 双机网络存储，保证高安全要求数据，并且配置 JBOD 集群存储，定时备份

> 企业 NAS 规划 基础逻辑为 JBOD 集群 归档 + 按业务搭建 对应的中介存储，并做好数据备份

在预算不足够的情况，其实对性能可以舍弃，建立 2级 NAS存储

1.  `归档级`存储，可以使用 Raid 5/6 组成 集群（2套以上即可）
2.  `托管级` 或者 `镜像级` 存储，使用 固态硬盘，组成 Raid 1 即可